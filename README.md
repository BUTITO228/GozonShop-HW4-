# Отчёт по домашнему заданию №4
**Работу выполнил:** Крайнов Ярослав БПИ247  
**Тема:** Асинхронное межсервисное взаимодействие в интернет‑магазине «Гоzон»
---

## Цель работы

Цель работы — разработать микросервисную систему интернет‑магазина, обеспечивающую асинхронное взаимодействие между сервисом заказов и сервисом оплат с гарантированной доставкой сообщений и семантикой effectively exactly once при списании средств со счёта пользователя.

---

## Архитектура решения

### Общая структура

Система включает следующие компоненты:

- **API Gateway** — принимает HTTP‑запросы клиентов и маршрутизирует их в Order Service и Payments Service.  
- **Order Service** — отвечает за создание заказа, получение списка заказов и статуса конкретного заказа.  
- **Payments Service** — управляет счётом пользователя: создание счёта, пополнение, просмотр баланса.  
- **PostgreSQL** — две отдельные базы данных для заказов и платежей.  
- **RabbitMQ** — брокер сообщений для асинхронного обмена событиями между сервисами.

Все сервисы упакованы в контейнеры и запускаются одной командой `docker-compose up --build`, что поднимает базы данных, брокер сообщений и все три микросервиса.

---

## Реализованный функционал

### Payments Service

В Payments Service реализованы все три требуемых сценария:

- Создание счёта по `user_id` (гарантируется не более одного счёта на пользователя).  
- Пополнение счёта на заданную сумму.  
- Получение текущего баланса счёта.

Баланс хранится в базе данных, а операции учитываются через связанные сущности (например, транзакции и outbox‑сообщения), что позволяет отслеживать историю и поддерживать корректное состояние счёта.

### Orders Service

В Orders Service реализованы сценарии:

- Создание заказа `Order(id, user_id, amount, description, status)`.  
- Получение списка заказов пользователя.  
- Получение статуса конкретного заказа (NEW, FINISHED, CANCELLED).

Создание заказа в одной транзакции записывает сам заказ и сообщение в outbox‑таблицу, после чего асинхронный процесс отправляет задачу на оплату в RabbitMQ.

---

## Асинхронное взаимодействие и надёжность

### Использование RabbitMQ

Обмен между Order Service и Payments Service реализован через очереди RabbitMQ, обеспечивающие at‑least‑once доставку сообщений.

- Очереди сконфигурированы как устойчивые.  
- Используется ручное подтверждение сообщений в консюмерах.  
- При ошибках предусмотрены повторные попытки обработки.

### Transactional Outbox / Inbox

В решении применены рекомендованные паттерны:

- **Transactional Outbox в Order Service**  
  - При создании заказа в одной транзакции создаётся запись о заказе и сообщение в таблице `OutboxMessages`.  
  - Фоновый сервис периодически читает неотправленные записи, публикует их в очередь RabbitMQ и помечает как отправленные.

- **Transactional Inbox + Outbox в Payments Service**  
  - Consumer платежных запросов сохраняет входящее сообщение в таблицу `InboxMessages` перед выполнением бизнес‑логики, обеспечивая идемпотентность обработки.  
  - После успешного списания средств формируется запись в `OutboxMessages` о результате (успех/ошибка), которую другой фоновый процесс отправляет в очередь и помечает как отправленную.

### Семантика effectively exactly once

Семантика effectively exactly once при списании средств достигается за счёт:

- хранения уникальных идентификаторов сообщений и проверок, не было ли событие уже обработано;  
- проверки текущего состояния счёта и заказа перед повторной обработкой;  
- разделения операций на атомарные шаги в рамках транзакций БД.

Даже при повторной доставке одного и того же сообщения деньги списываются не более одного раза для конкретного заказа.

---

## Докеризация и запуск

Для каждого сервиса подготовлен Dockerfile, выполняющий сборку и публикацию .NET‑приложения в контейнер.

Файл `docker-compose.yml`:

- поднимает два экземпляра PostgreSQL (для Orders и Payments);  
- поднимает RabbitMQ с панелью управления;  
- билдит и запускает API Gateway, Order Service и Payments Service, связывая их в общей сети;  
- настраивает переменные окружения (строки подключения к БД, параметры RabbitMQ).

После запуска `docker-compose up --build` система полностью разворачивается и готова к тестированию сценария создания и автооплаты заказа.

---

## Демонстрация через Swagger

Во всех сервисах подключён Swagger, что покрывает требование по демонстрации API:

- через API Gateway (порт 5000) доступны операции создания счёта, пополнения, проверки баланса, создания заказа, просмотра списка и статуса заказа;  
- сценарий создания заказа инициирует асинхронный процесс оплаты, который можно отследить по изменению статуса заказа и логам сервисов.

---

## Вывод

В результате работы реализована микросервисная система «Гоzон», удовлетворяющая требованиям задания: два микросервиса (Orders и Payments) с необходимым функционалом, асинхронное взаимодействие через RabbitMQ, использование Transactional Outbox/Inbox, семантика effectively exactly once при списании средств, а также полноценная контейнеризация и запуск всей системы через docker‑compose.  
Дополнительно система документирована через Swagger, что позволяет легко проверить все сценарии работы API.
